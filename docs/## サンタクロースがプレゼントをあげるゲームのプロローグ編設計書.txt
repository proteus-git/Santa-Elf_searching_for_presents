## サンタとエルフのプレゼントさがし＆配りゲーム 設計書

**1. ゲームの概要:**

*   **目的**: 3歳程度のこどもが、画面上のオブジェクトを操作して、プレゼントを探し出し（ステージ1）、動物たちに届ける（ステージ2）ことで、想像力と探求心を育む。さらに、ステージ3ではAIサンタとの会話を通じて「伝える力」を養う。
*   **構成**: 全3ステージ構成。
    *   **ステージ1 (Search)**: 森の中でプレゼントを探す。
    *   **ステージ2 (Delivery)**: 集めたプレゼントを動物たちに配る。
    *   **ステージ3 (Dialogue)**: サンタクロースと直接お話をして、欲しいものを伝える。
*   **対象年齢**: 3歳以上
*   **主要な機能**:
    *   **キャラクターの追従移動**: マウスカーソルをトナカイ→そり→サンタの順で追従（スネーク移動）。
    *   **動的なサイズ変化**: 移動速度に応じてキャラクターが伸縮（ゴムのような動き）。
    *   **ドラッグ＆ドロップ**: オブジェクトの移動・回収・配布。
    *   **ボイスAI (New)**: マイクを使ってサンタと会話（音声認識 & 音声合成）。
    *   **BGM**: `christmas-song.mp3` (ミュート機能付き)。

---

### **ステージ1: プレゼント探し (index.html)**

**1. 画面構成:**
*   **背景**: `snow-coveredtreehouse.webp` (昼の雪景色)
*   **UI**:
    *   ヘッダー: タイトル表示。
    *   インジケーター: エルフが探すべき「ターゲット」を指示。クリックでスキップ可能。
    *   インベントリ（袋）: 回収したアイテムを表示。
*   **オブジェクト**:
    *   プレゼント: どんぐり、木の実、ニンジン、マフラー、歯ブラシ、王冠。
    *   装飾: 石ころ、葉っぱ、小枝、木など。

**2. ゲームルール:**
*   **操作**: 画面上のオブジェクトをドラッグして、左下の「サンタの袋」に入れる。
*   **ターゲット**: エルフが指定したアイテムのみ回収可能。
*   **クリア条件**: 各種類のプレゼントを2個ずつ集める。
*   **クリア演出**:
    *   "Merry Christmas!" の文字が表示される。
    *   サンタたちが画面外へ飛び去る（縮小しながら移動）。
    *   自動的にステージ2へ遷移。

---

### **ステージ2: プレゼント配り (stage2.html)**

**1. 画面構成:**
*   **背景**: `nightsnow-coveredtreehouse.webp.png` (夜の雪景色)
*   **視覚効果**:
    *   **雪**: 降り積もる雪のアニメーション。
    *   **星空**: きらめく星と、サンタを追いかける**流れ星**（大きく、明るい）。
*   **キャラクター**:
    *   動物たち: リス、ウサギ、キリン、ライオン、ワニ。
    *   配置: 画面内の定位置に登場し、ゆらゆらと揺れる。

**2. ゲームルール:**
*   **操作**: インベントリからプレゼントをドラッグして、対応する動物に渡す。
*   **正解判定**:
    *   正しいプレゼントを渡すと、拡大オーバーレイが表示される。
    *   サンタと動物が向かい合い、プレゼントが渡されるアニメーション。
    *   動物が「喜び」の画像に切り替わる。
    *   **プレゼント装着**: 渡したプレゼントが動物の頭上に表示され、一緒に揺れる。
*   **クリア条件**: すべての動物にプレゼントを渡す。

**3. フィナーレ演出:**
*   全員に配り終えると、動物たちが一斉に "Thank you Santa!" と吹き出しで感謝する。
*   **インタラクティブ・フィナーレ**:
    *   プレイヤーがサンタを操作してツリーハウス（画面中央）の周りを旋回させる。
    *   **"Merry Christmas!"**: キラキラ輝く文字が画面いっぱいに表示され、その後サンタに追従する。
    *   旋回するごとにサンタたちが徐々に小さくなり、最終的に夜空へ消えていく。

---

### **ステージ3: サンタとのお話 (stage3.html)**

**1. 概要:**
*   プレイヤー（MIYAKOちゃん）がツリーハウスに登り、サンタクロースに直接プレゼントをお願いするストーリー体験型ステージ。
*   **技術要素**: Gemini API (v2.0 Flash) と Web Speech API を使用した、リアルタイム音声対話。

**2. 画面構成:**
*   **背景**: `snow-coveredtreehouse.webp` (大きなツリーハウス)。
*   **キャラクター**:
    *   **MIYAKO**: プレイヤーキャラクター。初期状態は通常の服。
    *   **サンタ一一行**: 2倍サイズで大きく表示（トナカイ、そり、サンタ）。
    *   **ARATA & TAKERU**: 最後にお祝いに駆けつけるお友達。

**3. シナリオ進行:**
1.  **オープニング**: 動物たちが祝福する中、MIYAKOちゃんが梯子を登って登場。
2.  **サンタ登場**: 上空からサンタが飛来し、MIYAKOちゃんに近づく。
3.  **会話パート (Voice AI)**:
    *   サンタ「何が欲しかったっけ？」と問いかける（おじいちゃんのような優しい声）。
    *   プレイヤーはマイクに向かって話す。
    *   **AIロジック**:
        *   Gemini 2.0 Flash が会話を制御。
        *   目的: プレイヤーに「エルサのドレス」と言わせる、またはそれを推測する。
        *   **文脈理解**: 「はい」「うん」などの返事も、直前の質問（「もしかしてプリンセスかな？」など）を記憶して正しく解釈する。
        *   **フォールバック**: APIエラー時は、ローカルのキーワードマッチングにより、ゲーム進行を止めない。
4.  **プレゼント贈呈**:
    *   会話が成立すると、プレゼントボックスが出現。
    *   箱が開き、中から `ELSADress` が現れて宙に浮く。
    *   **変身**: MIYAKOちゃんが `MiyakoElsa`（ドレス姿）に変身。
    *   **ダンス**: MIYAKOちゃんがくるりと回転するアニメーション（4方向スプライト）。
5.  **フィナーレ**:
    *   ARATAくん（LEGO）、TAKERUくん（乗り物図鑑）にも、拡大演出でプレゼントが渡される。
    *   全員で「ありがとう！」と叫び、サンタは夜空へ帰っていく。

**4. 技術仕様 (ステージ3特有):**
*   **API**: Google Gemini API (`models/gemini-2.0-flash-exp`).
*   **APIキー管理**: クライアントサイド (`localStorage`) に保存。
*   **音声合成**: `SpeechSynthesisUtterance` を使用し、ピッチ(0.6)と速度(0.8)を調整して老人の声を再現。
*   **アニメーション**: CSS Transform (`rotateY`, `scale`) と JavaScript タイマーによるスプライトアニメーション。

---

### **技術仕様 (共通)**

**1. ファイル構成:**
*   `index.html`: ステージ1
*   `stage2.html`: ステージ2
*   `stage3.html`: ステージ3
*   `docs/`: 設計書などのドキュメント。

**2. アセット運用:**
*   GitHubにて管理: `proteus-git/Santa-Elf_searching_for_presents`
*   画像アセットは `images/` ディレクトリに集約。

**3. 実装のポイント:**
*   **レスポンシブ**: PC/スマホ両対応。
*   **堅牢性**: APIエラーやマイク非対応環境でも、進行不能にならないようなフォールバック実装を徹底。
